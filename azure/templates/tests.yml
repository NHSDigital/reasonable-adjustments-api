parameters:
    - name: service_name
      type: string

steps:
    - bash: |
          pip install virtualenv
          virtualenv test_env
          source ./test_env/bin/activate
          pip install -r requirements.txt
      workingDirectory: $(Pipeline.Workspace)/s/${{ parameters.service_name }}/$(SERVICE_ARTIFACT_NAME)/api_tests
      displayName: Setup integration tests

    - bash: |
        test_dir="$(Pipeline.Workspace)/s/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/api_tests"
        source ./test_env/bin/activate

        export BASE_URL="https://$(APIGEE_ENVIRONMENT).api.service.nhs.uk/oauth2"
        export CLIENT_ID="$(CLIENT_ID)"
        export CLIENT_SECRET="$(CLIENT_SECRET)"
        export REDIRECT_URI="https://nhsd-apim-testing-internal-dev.herokuapp.com/callback"
        export AUTHENTICATE_URL="https://nhsd-apim-testing-$(APIGEE_ENVIRONMENT).herokuapp.com/"
        # echo API_URL="https://$(APIGEE_ENVIRONMENT).api.service.nhs.uk/hello-world/hello/user"
        export APIGEE_CLIENT_ID="969567331415.apps.national"
        export APIGEE_API_AUTHENTICATION="$(secret.AccessToken)"
        export APIGEE_API_URL="https://api.enterprise.apigee.com/v1/organizations/nhsd-nonprod"

        pytest -v --junitxml=test-report.xml

      workingDirectory: $(Pipeline.Workspace)/s/${{ parameters.service_name }}/$(SERVICE_ARTIFACT_NAME)/api_tests
      displayName: 'Run Postman tests'

    - task: PublishTestResults@2
      displayName: 'Publish Test Results'
      inputs:
          testResultsFiles: |
              $(Pipeline.Workspace)/s/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/api_tests/test-report.xml
          failTaskOnFailedTests: true
