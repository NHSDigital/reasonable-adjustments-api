parameters:
    - name: service_name
      type: string

steps:
    - bash: |
          docker build -t reasonable-adjustments-api/test-env:latest .

      workingDirectory: $(Pipeline.Workspace)/s/${{ parameters.service_name }}/$(SERVICE_ARTIFACT_NAME)/api_tests
      displayName: Setup integration tests

    - bash: |
        test_dir="$(Pipeline.Workspace)/s/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/api_tests"
        source ./test_env/bin/activate

        echo docker run --entrypoint "pytest" -v $(pwd):/var/api_tests/test_report.xml \
          -e BASE_URL="https://$(APIGEE_ENVIRONMENT).api.service.nhs.uk/oauth2" \
          -e CLIENT_ID="$(CLIENT_ID)" \
          -e CLIENT_SECRET="$(CLIENT_SECRET)" \
          -e REDIRECT_URI="https://nhsd-apim-testing-internal-dev.herokuapp.com/callback" \
          -e AUTHENTICATE_URL="https://nhsd-apim-testing-$(APIGEE_ENVIRONMENT).herokuapp.com/" \
          -e API_URL="https://$(APIGEE_ENVIRONMENT).api.service.nhs.uk/hello-world/hello/user" \
          -e APIGEE_CLIENT_ID="969567331415.apps.national" \
          -e APIGEE_API_AUTHENTICATION="$(secret.AccessToken)" \
          -e APIGEE_API_URL="https://api.enterprise.apigee.com/v1/organizations/nhsd-nonprod" \
          -e PROXY_NAME=$(SERVICE_BASE_PATH) \
          -e REASONABLE_ADJUSTMENTS_BASE_URL=https://internal-dev.api.service.nhs.uk \
          -e REASONABLE_ADJUSTMENTS_PROXY=${PROXY_NAME} \
          reasonable-adjustments-api/test-env:latest -v  --junitxml=reports/test_report.xml tests

        docker run --entrypoint "pytest" -v $(pwd):/var/api_tests/test_report.xml \
          -e BASE_URL="https://$(APIGEE_ENVIRONMENT).api.service.nhs.uk/oauth2" \
          -e CLIENT_ID="$(CLIENT_ID)" \
          -e CLIENT_SECRET="$(CLIENT_SECRET)" \
          -e REDIRECT_URI="https://nhsd-apim-testing-internal-dev.herokuapp.com/callback" \
          -e AUTHENTICATE_URL="https://nhsd-apim-testing-$(APIGEE_ENVIRONMENT).herokuapp.com/" \
          -e API_URL="https://$(APIGEE_ENVIRONMENT).api.service.nhs.uk/hello-world/hello/user" \
          -e APIGEE_CLIENT_ID="969567331415.apps.national" \
          -e APIGEE_API_AUTHENTICATION="$(secret.AccessToken)" \
          -e APIGEE_API_URL="https://api.enterprise.apigee.com/v1/organizations/nhsd-nonprod" \
          -e PROXY_NAME=$(SERVICE_BASE_PATH) \
          -e REASONABLE_ADJUSTMENTS_BASE_URL=https://internal-dev.api.service.nhs.uk \
          -e REASONABLE_ADJUSTMENTS_PROXY=${PROXY_NAME} \
          reasonable-adjustments-api/test-env:latest -v  --junitxml=reports/test_report.xml tests

#        pytest -v --junitxml=test-report.xml

      workingDirectory: $(Pipeline.Workspace)/s/${{ parameters.service_name }}/$(SERVICE_ARTIFACT_NAME)/api_tests
      displayName: 'Run Postman tests'

    - task: PublishTestResults@2
      displayName: 'Publish Test Results'
      inputs:
          testResultsFiles: |
              $(Pipeline.Workspace)/s/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/api_tests/test-report.xml
          failTaskOnFailedTests: true
